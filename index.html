<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>星火大模型-对话助手</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="chat-wrapper">
        <h1>LLM学习-星火对话助手</h1>
        <!-- 对话消息展示区 -->
        <div class="chat-messages" id="chatMessages"></div>
        <!-- 输入框与发送按钮 -->
        <div class="chat-input-area">
            <input type="text" id="userInput" placeholder="请输入你要提问的内容...">
            <button id="sendBtn">发送</button>
        </div>
    </div>

    <script>
        // ************************ 唯一需要修改的地方 ************************
        // 替换成你的 Flask 后端地址（本地测试：http://localhost:5000，部署后改服务器IP/域名）
        const BACKEND_URL = "http://localhost:5000/chat";
        // ******************************************************************

        // 获取页面元素
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');

        // 1. 向对话界面添加消息
        function addMessage(content, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? "user-message" : "ai-message";
            
            const messageContent = document.createElement('div');
            messageContent.className = "message-content";
            // 处理换行（星火回复可能有\n，转成<br>）
            messageContent.innerHTML = content.replace(/\n/g, '<br>');

            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);

            // 自动滚动到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 2. 调用后端接口获取星火回复
        async function getSparkReply(prompt) {
            try {
                // 构造请求参数
                const requestData = JSON.stringify({
                    message: prompt
                });

                // 发送 POST 请求到后端
                const response = await fetch(BACKEND_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: requestData
                });

                // 处理响应错误
                if (!response.ok) {
                    throw new Error(`接口响应失败：${response.status}`);
                }

                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }

                return data.reply;
            } catch (error) {
                console.error("调用失败：", error);
                return `抱歉，服务暂时不可用：${error.message}`;
            }
        }

        // 3. 发送按钮点击事件
        sendBtn.addEventListener('click', async () => {
            const userText = userInput.value.trim();
            if (!userText) return; // 空内容不发送

            // 添加用户消息到界面
            addMessage(userText, true);
            userInput.value = ""; // 清空输入框

            // 添加“正在思考中”提示
            const loadingDiv = document.createElement('div');
            loadingDiv.className = "ai-message loading";
            loadingDiv.innerHTML = '<div class="message-content">正在思考中...</div>';
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // 获取 AI 回复并替换提示
            const aiReply = await getSparkReply(userText);
            chatMessages.removeChild(loadingDiv);
            addMessage(aiReply, false);
        });

        // 4. 回车键触发发送
        userInput.addEventListener('keydown', (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault(); // 阻止换行
                sendBtn.click();
            }
        });

        // 5. 页面加载完成后添加欢迎消息
        window.onload = () => {
            addMessage("你好！我是星火大模型助手，有什么可以帮你的？", false);
        };
    </script>
</body>
</html>
